<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>test • shytab</title><meta name="description" content="test - shytab"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.svg"><link rel="stylesheet" href="https://unpkg.com/nanoreset/nanoreset.min.css"><link rel="stylesheet" href="/css/theme.css"><link rel="search" type="application/opensearchdescription+xml" href="/atom.xml" title="shytab"></head><body><div class="wrap" id="barba-wrapper"><header><h1 class="branding"><a href="/" title="shytab"><img class="logo-image" src="/logo.svg" alt="logo"></a></h1><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link no-barba" href="/" target="_self">HOME</a></li><li class="nav-list-item"><a class="nav-list-link no-barba" href="/archives" target="_self">ARCHIVES</a></li><li class="nav-list-item"><a class="nav-list-link no-barba" href="https://github.com/shytab" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link no-barba" href="/atom.xml" target="_self">RSS</a></li></ul></header><div class="barba-container"><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">test</h1><div class="post-info"><a></a>2017-10-10</div><div class="post-content"><p><a href="https://github.com/Yangqing/caffe/wiki/Convolution-in-Caffe:-a-memo" target="_blank" rel="external">https://github.com/Yangqing/caffe/wiki/Convolution-in-Caffe:-a-memo</a></p>
<p>In the last few months chatting with people about Caffe, a common comment I got was: “<em>Caffe’s convolution has some memory issues.</em>“</p>
<p>While this is true in some sense, I am not sure whether it is truly an issue - rather, <strong>it is a graduate-student level design choice when I was writing the Caffe framework in just 2 months’ budget with a looming thesis deadline</strong>. It turns out to have its own pros (faster than any trivial implementation unless you optimize really seriously) and cons (large memory consumption). A more detailed explanation follows, if you are interested.</p>
<p>First of all, convolution is, in some sense, quite hard to optimize. While the conventional definition of convolution in computer vision is usually just a single channel image convolved with a single filter (which is, actually, what Intel IPP’s convolution means), in deep networks we often perform convolution with multiple input channels (the word is usually interchangeable with “depth”) and multiple output channels.</p>
<p>Loosely speaking, assume that we have a W x H image with depth D at each input location. For each location, we get a K x K patch, which could be considered as a K x K x D vector, and apply M filters to it. In pseudocode, this is (ignoring boundary conditions):<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> w <span class="keyword">in</span> 1..W</div><div class="line">  <span class="keyword">for</span> h <span class="keyword">in</span> 1..H</div><div class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> 1..K</div><div class="line">      <span class="keyword">for</span> y <span class="keyword">in</span> 1..K</div><div class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> 1..M</div><div class="line">          <span class="keyword">for</span> d <span class="keyword">in</span> 1..D</div><div class="line">            output(w, h, m) += input(w+x, h+y, d) * filter(m, x, y, d)</div><div class="line">          end</div><div class="line">        end</div><div class="line">      end</div><div class="line">    end</div><div class="line">  end</div><div class="line">end</div></pre></td></tr></table></figure></p>
<p>Optimizing such a complex nested for loop is non-trivial. If you have tried optimizing matrix multiplication, you know that there is a lot of tricks involved in it. In my third year of PhD I did it in Berkeley’s CS267 (parallel computers) class, and we got the highest maximum performance <a href="http://www.cs.berkeley.edu/~ballard/cs267.sp11/hw1/results/" target="_blank" rel="external">[1]</a> among others after having two layers of caching, unrolled innermost computation, and SSE2 (AVX wasn’t available on the cluster we used). Optimization of convolution could only be more complex.</p>
<p>I have long admired Alex Krizhevsky’s great optimization in cuda-convnet <a href="http://code.google.com/p/cuda-convnet/" target="_blank" rel="external">[2]</a>. Unfortunately, I had to finish my thesis at the time, and I probably was not as GPU savvy as he is. But I still needed a fast convolution. Thus, I took a simpler approach: reduce the problem to a simpler one, where others have already optimized it really well.</p>
<p>The trick is to just lay out all the local patches, and organize them to a (W x H, K x K x D) matrix. In Matlab, this is usually known as an im2col operation. After that, consider the filters being a (M, K x K x D) matrix too, the convolution naturally gets reduced to a matrix multiplication (Gemm in BLAS) problem. We have awesome BLAS libraries such as MKL, Atlas, and CuBLAS, with impressive performances. This applies to GPUs as well, although GPU memory is indeed more “precious” than its CPU sibling. However, with reasonably large models such as ImageNet, Caffe has been working pretty OK. It is even able to process videos with such models, thanks to the recent advances in GPU hardware.</p>
<p>An additional benefit is that, since BLAS is usually optimized for all platforms by the BLAS distributors (like Intel and Nvidia), we don’t need to worry about optimization with specific platforms, and can sit back comfortably assuming that a reasonably fast speed can be achieved on almost all platforms that those BLAS libraries support.</p>
<p>Somewhat surprising to me is that, such a “lazy optimization” is quite efficient, better than several other approaches and only recently been beaten (as expected) by the mighty Krizhevsky’s optimized cuda-convnet2 code <a href="https://code.google.com/p/cuda-convnet2/" target="_blank" rel="external">[3]</a>:</p>
<p><a href="https://github.com/soumith/convnet-benchmarks" target="_blank" rel="external">https://github.com/soumith/convnet-benchmarks</a> (as of Jul 27, 2014)</p>
<p>So this is the story of the memory issue that came into play. I didn’t mean to defend it - in any means, it was designed as a <strong>temporary</strong> solution. Whenever this word pops up, it reminds me of this <a href="http://stackoverflow.com/questions/184618/what-is-the-best-comment-in-source-code-you-have-ever-encountered" target="_blank" rel="external">[4]</a>:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">// somedev1 -  6/7/02 Adding temporary tracking of Login screen</div><div class="line">// somedev2 -  5/22/07 Temporary my ass</div></pre></td></tr></table></figure></p>
<p>So we are having a lot of improvements being worked on by Berkeley folks and collaborators - things will apparently get better soon - expect a faster yet more memory-efficient convolution this fall.</p>
<p>For me, the lesson learned when writing Caffe as a grad student is simplicity: <strong>reduce my problem to one already solved</strong>. It sometimes burns <a href="http://www.reddit.com/r/Jokes/comments/27bgl8/a_math_joke/" target="_blank" rel="external">[5]</a>, but could always be improved later if necessary.</p>
<p>[1] <a href="http://www.cs.berkeley.edu/~ballard/cs267.sp11/hw1/results/" target="_blank" rel="external">http://www.cs.berkeley.edu/~ballard/cs267.sp11/hw1/results/</a></p>
<p>[2] <a href="http://code.google.com/p/cuda-convnet/" target="_blank" rel="external">http://code.google.com/p/cuda-convnet/</a></p>
<p>[3] <a href="https://code.google.com/p/cuda-convnet2/" target="_blank" rel="external">https://code.google.com/p/cuda-convnet2/</a></p>
<p>[4] <a href="http://stackoverflow.com/questions/184618/what-is-the-best-comment-in-source-code-you-have-ever-encountered" target="_blank" rel="external">http://stackoverflow.com/questions/184618/what-is-the-best-comment-in-source-code-you-have-ever-encountered</a></p>
<p>[5] <a href="http://www.reddit.com/r/Jokes/comments/27bgl8/a_math_joke/" target="_blank" rel="external">http://www.reddit.com/r/Jokes/comments/27bgl8/a_math_joke/</a></p>
</div></article></div></main><footer><div class="paginator"><a class="prev" href="/2017/10/12/hello-world/">prev</a></div><div class="copyright"><p>&copy; 2017 <a href="http://yoursite.com">shytab</a><br>Powered by <a href="https://hexo.io/" rel="noreferrer" target="_blank">Hexo</a></p></div></footer></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/barba.js/1.0.0/barba.min.js"></script><script>document.addEventListener('DOMContentLoaded', function() {
    Barba.Pjax.start()
})</script></body></html>